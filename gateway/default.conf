server {
    listen 80 default_server;
    listen [::]:80 default_server;

    # Global settings
    client_max_body_size 10M;
    limit_conn addr 10;

    # Custom error response for rate limiting
    error_page 429 = @ratelimit;
    
    location @ratelimit {
        default_type application/json;
        add_header Content-Type application/json always;
        return 429 $rate_limit_message;
    }

    # Admin Service - Strict rate limiting
    location /admin/ {
        limit_req zone=api_strict burst=5 nodelay;
        limit_req_status 429;
        
        set $upstream_admin admin-service:3009;
        rewrite ^/admin/(.*)$ /$1 break;
        proxy_pass http://$upstream_admin;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Auth Service - Very strict for login
    location /auth/login {
        limit_req zone=api_login burst=2 nodelay;
        limit_req_status 429;
        
        set $upstream_auth auth-service:3001;
        proxy_pass http://$upstream_auth/login;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Auth Service - Other endpoints
    location /auth/ {
        limit_req zone=api_strict burst=10 nodelay;
        limit_req_status 429;
        
        set $upstream_auth auth-service:3001;
        rewrite ^/auth/(.*)$ /$1 break;
        proxy_pass http://$upstream_auth;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Catalog Service - Public, higher rate limit
    location /catalog/ {
        limit_req zone=api_public burst=50 nodelay;
        limit_req_status 429;
        
        set $upstream_catalog catalog-service:3002;
        rewrite ^/catalog/(.*)$ /$1 break;
        proxy_pass http://$upstream_catalog;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Cart Service - General rate limiting
    location /cart/ {
        limit_req zone=api_general burst=20 nodelay;
        limit_req_status 429;
        
        set $upstream_cart cart-service:3003;
        rewrite ^/cart/(.*)$ /$1 break;
        proxy_pass http://$upstream_cart;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Order Service - Moderate rate limiting
    location /order/ {
        limit_req zone=api_general burst=15 nodelay;
        limit_req_status 429;
        
        set $upstream_order order-service:3004;
        rewrite ^/order/(.*)$ /$1 break;
        proxy_pass http://$upstream_order;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Payment Service - Strict rate limiting
    location /payment/ {
        limit_req zone=api_strict burst=5 nodelay;
        limit_req_status 429;
        
        set $upstream_payment payment-service:3005;
        rewrite ^/payment/(.*)$ /$1 break;
        proxy_pass http://$upstream_payment;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Notification Service - General rate limiting
    location /notification/ {
        limit_req zone=api_general burst=10 nodelay;
        limit_req_status 429;
        
        set $upstream_notification notification-service:3006;
        rewrite ^/notification/(.*)$ /$1 break;
        proxy_pass http://$upstream_notification;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Review Service - Public rate limiting
    location /review/ {
        limit_req zone=api_public burst=30 nodelay;
        limit_req_status 429;
        
        set $upstream_review review-service:3007;
        rewrite ^/review/(.*)$ /$1 break;
        proxy_pass http://$upstream_review;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # User Service - General rate limiting
    location /user/ {
        limit_req zone=api_general burst=20 nodelay;
        limit_req_status 429;
        
        set $upstream_user user-service:3008;
        rewrite ^/user/(.*)$ /$1 break;
        proxy_pass http://$upstream_user;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Media Service - Higher limit for uploads/downloads
    location /media/ {
        limit_req zone=api_public burst=40 nodelay;
        limit_req_status 429;
        client_max_body_size 50M;
        
        set $upstream_media media-service:3010;
        rewrite ^/media/(.*)$ /$1 break;
        proxy_pass http://$upstream_media;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # Static files
    location / {
        root /usr/share/nginx/html;
        index index.html;
    }
}